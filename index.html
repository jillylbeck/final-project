<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>What's Killing the Reef?</title>
  <style>
    
    *, *::before, *::after {
      box-sizing: border-box;
    }
    :root {
      --reef-bg-start: #00334e;
      --reef-bg-end:   #0077b6;
      --text-color:    #fff;
    }
    body {
      margin: 0;
      background: linear-gradient(to top, #00334e, #0077b6);
      color: white;
      font-family: 'Segoe UI', sans-serif;
      overflow-x: hidden;  /* only hide horizontal overflow */
      /* remove any overflow-y:hidden so charts can scroll */
    }
    header {
      text-align: center;
      padding: 1em;
      font-size: 2em;
      font-weight: bold;
      position: relative;
    }
    .bubble {
      position: absolute;
      bottom: -50px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.5);
      animation: bubble 8s infinite;
    }
    @keyframes bubble {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-100vh); opacity: 0; }
    }

    #aquarium {
        position: relative;
        width: 100%;
        height: 200px;
        background: #56c2e6;
        overflow: hidden;
        border-radius: 10px;
    }
    .fish {
        position: absolute;
        width: 40px;
        cursor: pointer;
    }

    #aquarium-container {
        display: flex;
        flex-direction: column;
    }

    #aquarium-selector {
        display: flex;
        flex-direction: horizontal;
    }

    #map-container {
      display: flex;
      flex-direction: row;          
      width: 100vw;
      height: calc(100vh - 3em);    
      overflow: hidden;
      gap: 20px;
    }

    #map {
      flex: 0 0 60%;                      
      min-width: 0;                 
      position: relative;
    }

    #map svg {
      margin-left: 20px;
    }

    #map g circle {
      cursor: pointer;
    }
    
    #map g circle:hover {
      opacity: 0.8;
    }
    
    #charts {
      flex: 0 0 40%;                     
      min-width: 0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;             
      position: relative;
    }

    #map svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    #charts svg {
      width: 100%;
      height: 300px;
      flex-shrink: 0;
      margin-bottom: 1em;          
    }

    .tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      color: black;
      padding: 5px 10px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 0.9em;
    }

    #map g circle.selected {
      stroke: #fff;
      stroke-width: 3px;
      filter: drop-shadow(0 0 6px #fff);
    }
    
    /*
    .legend {
      top: 640px;
      right: 30px;
      background: rgba(255, 255, 255, 0.8);
      color: black;
      margin-left: 400px;
      width: 170px;
      padding: 10px;
      border-radius: 5px;
    }

    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 8px;
      border-radius: 50%;
    }
    .svg-legend text {
      fill: white;
      font-size: 12px;
      font-family: 'Segoe UI', sans-serif;
    }
    .svg-legend circle {
      stroke: none;
    }
      */

    .svg-legend {
      background: rgba(0, 51, 78, 0.7);
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }
    .svg-legend text {
      fill: #fff;
      font-size: 13px;
      font-family: 'Segoe UI', sans-serif;
    }
    .svg-legend circle {
      stroke: #fff;
      stroke-width: 1px;
      r: 6;
    }

  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <header> Exploring the Health of Our Reefs </header>
  
  <div id = "aquarium-container">
    <p> Marine Biodiversity Aquarium </p>
    <div id = "aquarium"> </div>

    <div id = "aquarium-selector"> 
        <p> fish selection </p>
        <div id = "fishbowl"> </div>
        <div id = "diversity-chart"> 
            <svg id = "marine-chart" width = "600" height = "200"> </svg>
        </div>
    </div>
  </div>

  <div id="map-container">
    <!-- LEFT pane: the world map -->
    <div id="map"></div>

    <!-- RIGHT pane: one or more chart areas -->
    <div id="charts">
      <svg id="chart" width="800" height="300"></svg>
    </div>
  </div>

  <div class="tooltip" style="display:none;"></div>
  <script>
    const fishImages = ['images/fish.png', 'images/clown-fish.png', 'images/neon-tetras.png', 'images/puffer-fish.png', 'images/seahorse.png']; 
    // all icon images sourced from flat icon with following attribution: 
    /*  fish.png: 
    <a href="https://www.flaticon.com/free-icons/fish" title="fish icons">Fish icons created by Freepik - Flaticon</a>

    Neon tetras: 
    <a href="https://www.flaticon.com/free-icons/fish" title="fish icons">Fish icons created by Freepik - Flaticon</a>

    Puffer fish: 
    <a href="https://www.flaticon.com/free-icons/puffer-fish" title="puffer fish icons">Puffer fish icons created by Aranagraphics - Flaticon</a>

    Seahorse: 
    <a href="https://www.flaticon.com/free-icons/seahorse" title="seahorse icons">Seahorse icons created by Freepik - Flaticon</a>

    Clown Fish: 
    <a href="https://www.flaticon.com/free-icons/clown-fish" title="clown fish icons">Clown fish icons created by Freepik - Flaticon</a>

    */

    const aquariumDiv = document.getElementById('aquarium');


    for (let i = 0; i < 5; i++) {
    const fish = document.createElement('img');
    fish.src = fishImages[i % fishImages.length];
    fish.classList.add('fish');
    aquariumDiv.appendChild(fish);  // <-- append to #aquarium
    swimFish(fish, aquariumDiv);
    }

    function swimFish(fish, container) {
        let x = Math.random() * container.clientWidth;  // random starting x
        let amplitude = 20 + Math.random() * 20;
        let frequency = 0.01 + Math.random() * 0.01;
        let speed = (0.5 + Math.random()) * (Math.random() < 0.5 ? 1 : -1); // random direction
        let offset = Math.random() * (container.clientHeight - 50);

        function animate() {
            x += speed;

            // Check for hitting the left or right edge
            if (x <= 0 || x >= container.clientWidth - 40) { // assuming fish width ~40px
            speed *= -1; // reverse direction
            fish.style.transform = `scaleX(${speed > 0 ? 1 : -1})`; // flip fish image
            }

            const y = 40 + amplitude * Math.sin(x * frequency) + offset;
            fish.style.left = `${x}px`;
            fish.style.top = `${Math.min(Math.max(0, y), container.clientHeight - 40)}px`;

            requestAnimationFrame(animate);
        }

        animate();
        }


    for (let i = 0; i < 20; i++) {
      const bubble = document.createElement('div');
      bubble.classList.add('bubble');
      bubble.style.left = Math.random() * 5 + 'vw';
      bubble.style.animationDelay = Math.random() * 8 + 's';
      document.body.appendChild(bubble);

      const bubbleRight = bubble.cloneNode();
      bubbleRight.style.left = 95 + Math.random() * 5 + 'vw';
      document.body.appendChild(bubbleRight);
    }

    const svgMap = d3.select("#map").append("svg")
      .attr("width", 800)
      .attr("height", 600);

    //const projection = d3.geoNaturalEarth1()
    //  .scale(160)
    //  .translate([480, 300]);

    const mapW = +svgMap.attr("width"),
    mapH = +svgMap.attr("height");

    const projection = d3.geoNaturalEarth1()
      .scale(160)
      .translate([mapW * 0.55, mapH / 2]);

    const path = d3.geoPath().projection(projection);

    const tooltip = d3.select(".tooltip");

    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(worldData => {
      const countries = topojson.feature(worldData, worldData.objects.countries);

      svgMap.append("rect")
        .attr("width", 960)
        .attr("height", 600)
        .attr("opacity", .2)
        .attr("fill", "#ffffff");

      svgMap.append("path")
        .datum(countries)
        .attr("d", path)
        .attr("fill", "white")
        .attr("stroke", "#888");

      d3.csv("data/ocean.csv").then(data => {
        data.forEach(d => {
          d.Latitude = +d.Latitude;
          d.Longitude = +d.Longitude;
          d["SST (°C)"] = +d["SST (°C)"];
          d.Date = d3.timeParse("%Y-%m-%d")(d.Date);
        });

        const nested = d3.group(data, d => d.Location);
        const colorMap = { "None": "green", "Low": "yellow", "Medium": "orange", "High": "red" };

        nested.forEach((values, location) => {
          const latest = values[values.length - 1];
          const [x, y] = projection([latest.Longitude, latest.Latitude]);

          const point = svgMap.append("g")
            .attr("transform", `translate(${x},${y})`);
            point.append("circle")
            .attr("r", 10)
            .attr("fill", colorMap[latest["Bleaching Severity"]] || "gray")
            .on("mouseover", function(event) {
              d3.select(this).transition().attr("r", 15);
              tooltip.style("display", "block")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px")
                .html(`SST: ${latest["SST (°C)"]}°C<br>pH: ${latest["pH Level"]}<br>Bleaching: ${latest["Bleaching Severity"]}`);
            })
            .on("mouseout", function() {
              d3.select(this).transition().attr("r", 10);
              tooltip.style("display", "none");
            })
           // .on("click", () => drawChart(values, location));
            .on("click", function(event) {
             d3.selectAll("#map g circle").classed("selected", false);
             d3.select(this).classed("selected", true);
             const dotColor = d3.select(this).attr("fill");
             drawChart(values, location, dotColor);
           });

            point.append("text")
           .attr("y", -16)              
            .attr("text-anchor", "middle")
            .attr("fill", "navy")
            .style("font-size", "12px")
            .style("paint-order", "stroke")            // als test
            .style("stroke", "white")                  // als test
            .style("stroke-width", 3)                  // als test
            .text(location);


        //alternative way w highlight in back
      //      point.append("text")
      //       .attr("y", -16)
      //       .attr("text-anchor", "middle")
      //        .attr("fill", "#00334e")
      //        .style("font-size", "12px")
      //        .text(location)
      //        .each(function() {
      //          const t = d3.select(this),
      //                bbox = this.getBBox(),
      //                padX = 6, padY = 4;
      //          d3.select(this.parentNode)
      //            .insert("rect", "text")
      //            .attr("x", bbox.x - padX)
      //            .attr("y", bbox.y - padY)
      //            .attr("width",  bbox.width + padX*2)
      //            .attr("height", bbox.height + padY*2)
      //            .attr("rx", 4)
      //            .attr("fill", "rgba(255,255,255,0.8)")
      //            .style("filter", "drop-shadow(0 1px 2px rgba(0,0,0,0.3))");
      //        });

        });

        const legend = svgMap.append("g")
            .attr("transform", "translate(30, 500)")
            .attr("class", "svg-legend");

        legend.append("text")
            .attr("x", 0)
            .attr("y", -10)
            .attr("fill", "white")
            .style("font-size", "14px")
            .text("Coral Bleaching Risk:");

        const riskLevels = [
            { label: "High", color: "red" },
            { label: "Medium", color: "orange" },
            { label: "Low", color: "yellow" },
            { label: "None", color: "green" }
            ];

        riskLevels.forEach((risk, i) => {
            legend.append("circle")
                .attr("cx", 0)
                .attr("cy", i * 20)
                .attr("r", 6)
                .attr("fill", risk.color);

            legend.append("text")
                .attr("x", 15)
                .attr("y", i * 20 + 4)
                .attr("fill", "white")
                .style("font-size", "12px")
                .text(risk.label);
            });
      });
    });


  function drawChart(values, location, strokeColor = "#4dd0e1") {
  d3.select("#chart").html("");
  const svg = d3.select("#chart")
    .attr("width", +d3.select("#chart").style("width").slice(0, -2))
    .attr("height", +d3.select("#chart").style("height").slice(0, -2))
    .html("");

  const margin = { top: 30, right: 30, bottom: 60, left: 80 },
        width  = +svg.attr("width")  - margin.left - margin.right,
        height = +svg.attr("height") - margin.top  - margin.bottom;

  svg.append("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("width",  width + margin.left + margin.right)
    .attr("height", height + margin.top  + margin.bottom)
    .attr("fill", "#002e4c");

  const g = svg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  const usableWidth = width * 0.9;
  const x = d3.scaleTime()
    .domain(d3.extent(values, d => d.Date))
    .range([0, usableWidth]);

  const y = d3.scaleLinear()
    .domain([
      d3.min(values, d => d["SST (°C)"]) - 1,
      d3.max(values, d => d["SST (°C)"]) + 1
    ])
    .range([height, 20]);

  g.append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x));

  g.append("g")
    .call(d3.axisLeft(y));

  g.append("text")
    .attr("x", width / 2 - 10)
    .attr("y", 5)
    .attr("text-anchor", "middle")
    .attr("fill", "white")
    .text("Location: " + location);

  // x‐axis label
  g.append("text")
    .attr("x", width * 0.9)
    .attr("y", height * 1.1)
    .attr("text-anchor", "middle")
    .attr("fill", "white")
    .text("Date");

  // y‐axis label
  g.append("text")
    .attr("transform", `rotate(-90)`)
    .attr("y", -40)
    .attr("x", -height / 2)
    .attr("text-anchor", "middle")
    .attr("fill", "white")
    .text("Sea Surface Temperature (°C)");

  // line generator
  const line = d3.line()
    .x(d => x(d.Date))
    .y(d => y(d["SST (°C)"]));

  // draw the line using the passed‐in color
  g.append("path")
    .datum(values)
    .attr("fill", "none")
    .attr("stroke", strokeColor)
    .attr("stroke-width", 2.5)
    .attr("d", line);
}

  </script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
</body>
</html>









