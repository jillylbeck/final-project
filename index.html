<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>What's Killing the Reef?</title>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --reef-bg-start: #00334e;
      --reef-bg-end:   #0077b6;
      --accent:        #4dd0e1;
      --text-light:    #e0f7ff;
      --text-muted:    #a0cfe8;
    }
    body {
      margin: 0;
      background: linear-gradient(180deg, var(--reef-bg-start), var(--reef-bg-end));
      color: var(--text-light);
      font-family: 'Work Sans', sans-serif;
      overflow-x: hidden;
      line-height: 1.6;
    }
    header {
      text-align: center;
      padding: 2rem 1rem;
      background: rgba(0,20,40,0.7);
      backdrop-filter: blur(4px);
    }
    header h1 {
      margin: 0;
      font-weight: 600;
      font-size: 2.5rem;
    }
    header .tagline {
      margin: 0.5rem 0 0;
      font-weight: 300;
      font-size: 1.1rem;
      color: var(--text-muted);
    }

    /* AQUARIUM LAYOUT */
    #aquarium-container {
      margin: 2rem auto;
      max-width: 1200px;
      padding: 0 1rem;
    }
    #aquarium {
      width: 100%;
      height: 300px;
      background: linear-gradient(to bottom, #56c2e6 0%, #00334e 100%);
      border-radius: 16px;
      border: 4px solid #1b4d66;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
    }
    .fish {
      position: absolute;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .fish:hover { transform: scale(1.05); }

    /* SELECTOR FLEX */
    #aquarium-selector {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
      max-width: 1200px;
      margin: 2rem auto 0;
    }
    #fishbowl-container {
      flex: 0 0 300px;
      text-align: center;
    }
    #fishbowl {
      width: 100%;
      aspect-ratio: 1;
      background: url('images/fishbowl.png') center/cover no-repeat;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      position: relative;
    }
    /* constrain selected fish inside bowl */
    #fishbowl img {
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 60%;
      max-height: 60%;
      pointer-events: none;
    }
    #selected-reef-label {
      margin: 0.5rem 0;
      font-weight: 600;
      color: var(--accent);
    }
    #diversity-chart {
      flex: 1;
      background: rgba(0,20,40,0.4);
      border-radius: 8px;
      padding: 0.5rem;
    }
    #marine-chart {
      width: 100%;
      height: 350px;
    }

    /* MAP FLEX */
    #map-container {
      margin: 2rem auto;
      text-align: center;
    }

    #map {
      flex: 1;
      height: 600px;
    }
    #charts {
      width: 100%;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 1rem;
      background: rgba(0,20,40,0.3);
      border-radius: 12px;
    }
    #map svg {
      width: 100%;
      max-width: 1200px;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    #charts svg {
      width: 100%;
      height: 100%;
    }

    /* TOOLTIP & LEGEND */
    .tooltip {
      position: absolute;
      background: rgba(255,255,255,0.9);
      color: #000;
      padding: 0.5rem;
      border-radius: 4px;
      pointer-events: none;
      font-size: 0.9rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 10;
      display: none;
    }
    .svg-legend {
      position: absolute;
      background: rgba(0,20,40,0.6);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .svg-legend text { fill: var(--text-light); font-size: 0.9rem; }
    .svg-legend circle { stroke: var(--text-light); stroke-width: 1px; r: 6; }

    /* GRIDLINES */
    .grid line { stroke: rgba(255,255,255,0.1); stroke-dasharray: 4 4; }
    .grid path { display: none; }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<body>
  <header>
    <h1>Exploring the Health of Our Reefs</h1>
    <p class="tagline">Dive deep into ocean ecosystems—see how they’re changing, and why it matters.</p>
  </header>

  <div id="aquarium-container">
    <p style="text-align:center; color:var(--text-muted);">Marine Biodiversity Aquarium</p>
    <div id="aquarium"></div>

    <div id="aquarium-selector">
      <div id="fishbowl-container">
        <p id="selected-reef-label">Select a Reef</p>
        <div id="fishbowl"></div>
      </div>
      <div id="diversity-chart">
        <svg id="marine-chart" width="800" height="350"></svg>
      </div>
    </div>
  </div>

  <div id="year-slider-container" style="margin: 2rem auto; text-align: center; color: white;">
    <label for="yearSlider">Select Year: <span id="yearLabel">---</span></label><br/>
    <input type="range" id="yearSlider" min="2000" max="2025" step="1" value="2020" style="width: 80%;">
  </div>

  <div id="map-container">
    <h2 style="color:white; font-size:1.5rem; margin-bottom: 1rem;">Bleaching Risk Map</h2>
    <div id="map" style="display: inline-block;"></div>
  </div>
  
  <div id="charts">
    <div id="chart-wrapper" style="text-align: center;">
      <button id="freezeChartBtn" style="margin-bottom: 1rem; padding: 0.5rem 1rem; font-size: 1rem; background: #4dd0e1; border: none; color: black; border-radius: 6px; cursor: pointer;">
        Freeze This Chart
      </button>
      <svg id="chart" width="400" height="440"></svg>
    </div>
    <div id="frozen-charts" style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 1rem;"></div>
  </div>

  <div class="tooltip"></div>

  <script>
    const fishImages = [
      'images/fish.png',
      'images/clown-fish.png',
      'images/neon-tetras.png',
      'images/puffer-fish.png',
      'images/seahorse.png',
      'images/jellyfish.png',
      'images/red-snapper-fish.png'
    ];

    const aquariumDiv = document.getElementById('aquarium');
    const fishbowl    = document.getElementById('fishbowl');
    const tooltip     = d3.select(".tooltip");

    // Fish swimming animation with top‐bounce
    function swimFish(fishContainer, container) {
      let x = Math.random() * container.clientWidth;
      let amplitude = 20 + Math.random() * 20;
      let frequency = 0.01 + Math.random() * 0.01;
      let speed = (0.5 + Math.random() * 0.2) * (Math.random() < 0.5 ? 1 : -1);
      let offset = Math.random() * (container.clientHeight - 50);

      function animate() {
        x += speed;
        if (x <= 0 || x >= container.clientWidth - fishContainer.clientWidth) {
          speed *= -1;
          const fishImg = fishContainer.querySelector('img');
          if (fishImg) fishImg.style.transform = `scaleX(${speed > 0 ? 1 : -1})`;
        }
        let y = 40 + amplitude * Math.sin(x * frequency) + offset;
        if (y <= 0) {
          speed = -speed;
          y = 0;
          const fishImg = fishContainer.querySelector('img');
          if (fishImg) fishImg.style.transform = `scaleX(${speed > 0 ? 1 : -1})`;
        }
        y = Math.min(Math.max(0, y), container.clientHeight - fishContainer.clientHeight);

        fishContainer.style.left = `${x}px`;
        fishContainer.style.top  = `${y}px`;
        requestAnimationFrame(animate);
      }
      animate();
    }

    for (let i = 0; i < 20; i++) {
      const bubble = document.createElement('div');
      bubble.classList.add('bubble');
      bubble.style.left = Math.random() * 5 + 'vw';
      bubble.style.animationDelay = Math.random() * 8 + 's';
      document.body.appendChild(bubble);
      const bubbleRight = bubble.cloneNode();
      bubbleRight.style.left = 95 + Math.random() * 5 + 'vw';
      document.body.appendChild(bubbleRight);
    }

    const svgMap = d3.select("#map").append("svg")
      .attr("width", 1000)
      .attr("height", 600)
      .style("margin", "0 auto")
      .style("display", "block");

    const projection = d3.geoNaturalEarth1()
      .scale(200)
      .translate([500, 300]); 


    const path = d3.geoPath().projection(projection);

    // Load CSV data
    d3.csv("data/ocean.csv").then(data => {
      data.forEach(d => {
        d.Latitude = +d.Latitude;
        d.Longitude = +d.Longitude;
        d["SST (°C)"] = +d["SST (°C)"];
        d["Species Observed"] = +d["Species Observed"];
        d.Date = d3.timeParse("%Y-%m-%d")(d.Date);
      });

      // Group by reef location
      const grouped = d3.group(data, d => d.Location);
      const reefData = Array.from(grouped, ([location, records]) => {
        records.sort((a, b) => d3.ascending(a.Date, b.Date));
        return {
          location,
          latest: records[records.length - 1],
          history: records
        };
      });

      // Fish size scale
      const speciesCounts = reefData.map(d => d.latest["Species Observed"]);
      const fishSizeScale = d3.scaleLinear()
        .domain([d3.min(speciesCounts), d3.max(speciesCounts)])
        .range([40, 100]);

      // Create fish in aquarium
      reefData.forEach((reef, i) => {
        const container = document.createElement('div');
        container.style.position = "absolute";
        container.style.textAlign = "center";

        const img = document.createElement('img');
        img.src = fishImages[i % fishImages.length];
        img.classList.add('fish');
        img.style.width = `${fishSizeScale(reef.latest["Species Observed"])}px`;
        img.dataset.location = reef.location;

        const label = document.createElement('div');
        label.textContent = reef.location;
        label.style.position = "absolute";
        label.style.top = "70px";
        label.style.left = "50%";
        label.style.transform = "translateX(-50%)";
        label.style.color = "white";
        label.style.fontSize = "12px";
        label.style.pointerEvents = "none";

        container.appendChild(img);
        container.appendChild(label);
        aquariumDiv.appendChild(container);
        swimFish(container, aquariumDiv);

        // Tooltip handlers
        img.addEventListener('mouseover', event => {
          tooltip
            .style("display", "block")
            .style("left",  (event.pageX + 10) + "px")
            .style("top",   (event.pageY - 20) + "px")
            .html(`Location: ${reef.location}<br>Species Observed: ${reef.latest["Species Observed"]}`);
        });
        img.addEventListener('mousemove', event => {
          tooltip
            .style("left", (event.pageX + 10) + "px")
            .style("top",  (event.pageY - 20) + "px");
        });
        img.addEventListener('mouseout', () => {
          tooltip.style("display", "none");
        });

        // Click to select + autoscroll
        img.addEventListener('click', () => {
          fishbowl.innerHTML = '';
          const sel = document.createElement('img');
          sel.src = img.src;
          sel.style.width = "100px";
          fishbowl.appendChild(sel);
          document.getElementById('selected-reef-label').textContent =
            `Selected Reef: ${reef.location}`;
          drawDiversityChart(reef.history, reef.location);
          fishbowl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
      });

      //updating map to work with slider
    function updateMapAndChartForYear(year) {
        // Filter reef data for selected year
        const filtered = reefData.map(reef => {
          const record = reef.history.find(d => d3.timeFormat("%Y")(d.Date) == year);
          return record ? { ...record, location: reef.location } : null;
        }).filter(Boolean);

        // Update map circles (color and tooltip)
        svgMap.selectAll("circle").each(function(_, i) {
          const reef = filtered[i];
          if (!reef) return;

          const colorMap = {
            "None": "green", "Low": "yellow", "Medium": "orange", "High": "red"
          };
          d3.select(this)
            .transition()
            .duration(300)
            .attr("fill", colorMap[reef["Bleaching Severity"]] || "gray");
        });

        // Auto-update chart for selected reef (if any)
        const selected = document.getElementById("selected-reef-label").textContent.replace("Selected Reef: ", "").trim();
        const selectedReef = reefData.find(r => r.location === selected);
        if (selectedReef) {
          drawTemperatureChart(selectedReef.history.filter(d => d3.timeFormat("%Y")(d.Date) == year), selectedReef.location);
        }
      }

      //making slider functionality
      let currentYear = 2020;
      const yearSlider = document.getElementById("yearSlider");
      const yearLabel = document.getElementById("yearLabel");
      yearLabel.textContent = currentYear;

      // Update slider bounds based on your data
      d3.csv("data/ocean.csv").then(allData => {
        const years = allData.map(d => +d.Date.split("-")[0]);
        const minYear = d3.min(years);
        const maxYear = d3.max(years);
        yearSlider.min = minYear;
        yearSlider.max = maxYear;
        yearSlider.value = maxYear;
        yearLabel.textContent = maxYear;
        currentYear = maxYear;

        yearSlider.addEventListener("input", () => {
          currentYear = +yearSlider.value;
          yearLabel.textContent = currentYear;
          updateMapAndChartForYear(currentYear);
        });
      });



      // Draw the diversity over time chart
      function drawDiversityChart(values, location) {
        const svg = d3.select("#marine-chart").html("");
        const margin = { top: 40, right: 20, bottom: 50, left: 60 };
        const width  = +svg.attr("width")  - margin.left - margin.right;
        const height = +svg.attr("height") - margin.top  - margin.bottom;

        const g = svg.append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleTime()
          .domain(d3.extent(values, d => d.Date))
          .range([0, width]);

        const y = d3.scaleLinear()
          .domain([0, d3.max(values, d => d["Species Observed"]) * 1.1])
          .range([height, 0]);

        g.append("g")
          .attr("class", "grid x-grid")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x).tickSize(-height).tickFormat(""));
        g.append("g")
          .attr("class", "grid y-grid")
          .call(d3.axisLeft(y).tickSize(-width).tickFormat(""));

        g.append("g")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y")))
          .selectAll("text").attr("fill", "#fff");
        g.append("g")
          .call(d3.axisLeft(y).ticks(5))
          .selectAll("text").attr("fill", "#fff");

        svg.append("text")
          .attr("x", margin.left + width/2)
          .attr("y", margin.top + height + 40)
          .attr("text-anchor", "middle")
          .attr("fill", "white")
          .text("Year");
        svg.append("text")
          .attr("transform", `translate(${margin.left - 45},${margin.top + height/2})rotate(-90)`)
          .attr("text-anchor", "middle")
          .attr("fill", "white")
          .text("Species Observed");
        svg.append("text")
          .attr("x", margin.left + width/2)
          .attr("y", 20)
          .attr("text-anchor", "middle")
          .attr("fill", "white")
          .style("font-size", "1.2em")
          .text(`Species Diversity Over Time: ${location}`);

        g.append("path")
          .datum(values)
          .attr("fill", "rgba(77, 208, 225, 0.3)")
          .attr("d", d3.area()
            .x(d => x(d.Date))
            .y0(height)
            .y1(d => y(d["Species Observed"]))
          );
        g.append("path")
          .datum(values)
          .attr("fill", "none")
          .attr("stroke", "#4dd0e1")
          .attr("stroke-width", 2)
          .attr("d", d3.line()
            .x(d => x(d.Date))
            .y(d => y(d["Species Observed"]))
          );
        g.selectAll("circle")
          .data(values)
          .enter().append("circle")
            .attr("cx", d => x(d.Date))
            .attr("cy", d => y(d["Species Observed"]))
            .attr("r", 4)
            .attr("fill", "#fff")
            .attr("stroke", "#4dd0e1")
            .on("mouseover", (event,d) => {
              tooltip.style("display","block")
                     .style("left",(event.pageX+10)+"px")
                     .style("top",(event.pageY-30)+"px")
                     .html(`Year: ${d3.timeFormat("%Y")(d.Date)}<br/>Count: ${d["Species Observed"]}`);
            })
            .on("mouseout", () => tooltip.style("display","none"));
      }

      // Load world map and plot bleaching circles
      d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(worldData => {
        const countries = topojson.feature(worldData, worldData.objects.countries);
        svgMap.append("path")
          .datum(countries)
          .attr("d", path)
          .attr("fill", "white")
          .attr("stroke", "#888");

        const colorMap = {
          "None":   "green",
          "Low":    "yellow",
          "Medium": "orange",
          "High":   "red"
        };

        reefData.forEach(reef => {
          const [x, y] = projection([reef.latest.Longitude, reef.latest.Latitude]);
          const point = svgMap.append("g")
            .attr("transform", `translate(${x},${y})`);

          point.append("circle")
            .attr("r", 10)
            .attr("fill", colorMap[reef.latest["Bleaching Severity"]] || "gray")
            .on("mouseover", function(event) {
              const selectedYear = +document.getElementById("yearSlider").value;
              const yearData = reef.history.find(d => +d3.timeFormat("%Y")(d.Date) === selectedYear);

              d3.select(this).transition().attr("r", 15);

              if (yearData) {
                tooltip.style("display","block")
                      .style("left",(event.pageX+10)+"px")
                      .style("top",(event.pageY-20)+"px")
                      .html(
                        `Year: ${selectedYear}<br>` +
                        `SST: ${yearData["SST (°C)"]}°C<br>` +
                        `pH: ${yearData["pH Level"]}<br>` +
                        `Bleaching: ${yearData["Bleaching Severity"]}`
                      );
              } else {
                tooltip.style("display","block")
                      .style("left",(event.pageX+10)+"px")
                      .style("top",(event.pageY-20)+"px")
                      .html(`No data for ${selectedYear}`);
              }
            })
            .on("mouseout", function() {
              d3.select(this).transition().attr("r", 10);
              tooltip.style("display","none");
            })
            .on("click", () => {
              const selectedYear = +document.getElementById("yearSlider").value;
              const yearData = reef.history.find(d => +d3.timeFormat("%Y")(d.Date) === selectedYear);

              if (yearData) {
                drawSingleYearBarChart(yearData, reef.location, selectedYear);
                document.getElementById('selected-reef-label').textContent = `Selected Reef: ${reef.location}`;
              } else {
                alert(`No data for ${reef.location} in ${selectedYear}`);
              }
            });


          const label = point.append("text")
            .attr("y", -16)
            .attr("text-anchor", "middle")
            .attr("font-size", "11px")
            .attr("fill", "black")
            .text(reef.location);

          const bbox = label.node().getBBox();
          point.insert("rect", "text")
            .attr("x", bbox.x - 2)
            .attr("y", bbox.y - 1)
            .attr("width", bbox.width + 4)
            .attr("height", bbox.height + 2)
            .attr("fill", "white")
            .attr("rx", 2)
            .attr("ry", 2);
        });

        // Legend
        const legend = svgMap.append("g")
          .attr("class", "svg-legend")
          .attr("transform", "translate(30,500)");
        legend.append("text")
          .attr("x", 0)
          .attr("y", -10)
          .style("font-size", "14px")
          .text("Bleaching Risk:");
        ["High","Medium","Low","None"].forEach((label,i) => {
          const color = colorMap[label];
          legend.append("circle")
            .attr("cx", 0)
            .attr("cy", i*20)
            .attr("r", 6)
            .attr("fill", color);
          legend.append("text")
            .attr("x", 15)
            .attr("y", i*20 + 4)
            .text(label);
        });
      });
    });

    function drawSingleYearBarChart(data, location, year) {
      const svg = d3.select("#chart");
      svg.selectAll("*").remove();
      const margin = { top: 40, right: 20, bottom: 60, left: 70 };
      const width = +svg.attr("width") - margin.left - margin.right;
      const height = +svg.attr("height") - margin.top - margin.bottom;
      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      const keys = ["SST (°C)", "Species Observed"];
      const values = [data["SST (°C)"], data["Species Observed"]];
      const color = d3.scaleOrdinal().domain(keys).range(["#4dd0e1", "orange"]);

      const x = d3.scaleBand()
        .domain(keys)
        .range([0, width])
        .padding(0.4);

      const y = d3.scaleLinear()
        .domain([0, d3.max(values) * 1.2])
        .range([height, 0]);

      g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));
      
      g.append("g").call(d3.axisLeft(y));

      g.selectAll("rect")
        .data(keys)
        .enter()
        .append("rect")
        .attr("x", d => x(d))
        .attr("y", d => y(data[d]))
        .attr("width", x.bandwidth())
        .attr("height", d => height - y(data[d]))
        .attr("fill", d => color(d))
        .on("mouseover", function(event, d) {
          tooltip.style("display", "block")
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 20) + "px")
            .html(`${d}: ${data[d].toFixed(2)}`);
        })
        .on("mouseout", () => tooltip.style("display", "none"));

      svg.append("text")
        .attr("x", margin.left + width / 2)
        .attr("y", margin.top - 10)
        .attr("text-anchor", "middle")
        .attr("fill", "#fff")
        .style("font-size", "16px")
        .text(`Reef Data for ${location} (${year})`);
    }

    document.getElementById("freezeChartBtn").addEventListener("click", () => {
    const svg = d3.select("#chart").node();
    const clone = svg.cloneNode(true);
    const container = document.createElement("div");
    container.style.border = "2px solid #4dd0e1";
    container.style.borderRadius = "8px";
    container.style.padding = "8px";
    container.style.background = "rgba(255,255,255,0.05)";
    container.style.flex = "0 0 400px";

    container.appendChild(clone);
    document.getElementById("frozen-charts").appendChild(container);
  });


  </script>
</body>
</html>